<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>반달섬 마리나 큐브</title>
    <link rel="stylesheet" type="text/css" href="style/main.css">
    <script src="http://code.jquery.com/jquery-latest.js"></script>
</head>
<body>
    <div class="header-area">
        <div class="topbar">
            <div class="topbar_menu">
                <ul>
                    <a href="#" id="phone">
                        <img src="images/phone1.png" style="top:2px;position:relative" height="16" width="16"/>
                        &nbsp;대표번호 1877-7449
                    </a>
                </ul>
            </div>
        </div>
        <div class="header_title_area">
            <img src="images/banner2.jpg" id="banner1">
            <div id="header_title">반달섬 마리나 큐브</div>
        </div>
        <nav class="header_nav">
            <ul class="menu_list">
                <li class="menu" id="menu_1"><a href="javascript:void(0)">반달섬 마리나 큐브</a></li>
                <li class="menu" id="menu_2"><a href="javascript:void(0)">사업개요</a></li>
                <li class="menu" id="menu_3"><a href="javascript:void(0)">교통안내</a></li>
                <li class="menu" id="menu_4"><a href="javascript:void(0)">고객접수</a></li>
                <li class="menu" id="menu_5"><a href="javascript:void(0)">평면도</a></li>
                <li class="menu" id="menu_6"><a href="javascript:void(0)">커뮤니티</a></li>
                <li class="menu" id="menu_7"><a href="javascript:void(0)">주변입지</a></li>
                <li class="menu" id="test_8"><a href="javascript:void(0)">Test</a></li>
            </ul>
        </nav>
    </div>
    <div class="body-area">
        <div class="main-content">

        </div>
    </div>
    <div class="footer-area">

    </div>
    <script>
        const allMenu = document.querySelectorAll('.menu');
        window.onload = function(){
            allMenu[0].classList.add('active');
            getContent(allMenu[0].id);

            for(var i=0; i<allMenu.length; i++){
                allMenu[i].addEventListener('click', function(){
                    $("li[class='menu active']").attr('class','menu');
                    this.classList.add('active');
                    const menuId = this.id
                    getContent(menuId);
                })
            }
        }

        function getContent(data) {
            $(".main-content").empty();
            var data = {'data' : data};
            data = JSON.stringify(data);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '../main/content');
            xhr.setRequestHeader('Content-Type',"application/json");
            xhr.send(data);

            xhr.addEventListener('load', function(){
                if(xhr.responseText){
                    const main_content = document.querySelector('.main-content');
                    main_content.innerHTML = xhr.responseText;
                    $(".slide").mouseover(function(){
                        $(".slide").attr('class','slide is-paused');
                    });
                    $(".slide").mouseout(function(){
                        $(".slide").attr('class','slide');
                    });
                    $(".contents").mouseover(function(){
                        if($(".btn_group").length==0 && $(".editForm").length==0){
                            const parent = this;
                            parent.setAttribute('class', 'contents editable');
                            const div = $("<div>").attr('class','btn_group');
                            const btn = $("<button>").attr('class','edit').text('수정');
                            btn.appendTo(div);
                            div.prependTo(parent);

                            div[0].addEventListener('click',function(event){
                                div[0].remove();
                                const parent = event.path[2];
                                const content = parent.children[0];
                                parent.className = 'contents editMode';
                                const editForm = $("<form>").attr({class:'editForm',action:'/main/update', method:'POST'});
                                var update = '';
                                var tag = '';
                                var num = '';
                                if(content.tagName=='DIV'){
                                    if(content.className!=null && content.className=='slide'){
                                        const imgList = $('.slide').children().children().children();
                                        var srcList =''
                                        for(var i=0; i<imgList.length; i++){
                                            if(imgList.length-1 == i){
                                                srcList = srcList + imgList[i].getAttribute('src')
                                            } else {
                                                srcList = srcList + imgList[i].getAttribute('src') + ',';
                                            }
                                        }
                                        update = $("<input>").attr({type:'hidden', name:'editData', value:srcList});
                                        tag = $("<input>").attr({type:'hidden', name:'tag', value:'IMG'});
                                        num = $("<input>").attr({type:'hidden', name:'num', value:parent.id});
                                    }
                                } else if(content.tagName=='IMG'){
                                    const imgSrc = content.getAttribute('src');
                                    update = $("<input>").attr({type:'hidden', name:'editData', value:imgSrc});
                                    tag = $("<input>").attr({type:'hidden', name:'tag', value:'IMG'});
                                    num = $("<input>").attr({type:'hidden', name:'num', value:parent.id});
                                } else {
                                    content.style.display = 'none';
                                    //편집모드 전환, textarea 생성
                                    update = $("<textarea>").attr({class:'editContent',rows:'3',cols:'120',name:'editData'})
                                    update.html(content.innerHTML.replaceAll("<br>","\n"));
                                    num = $("<input>").attr({type:'hidden', name:'num', value:parent.id});
                                    tag = $("<input>").attr({type:'hidden', name:'tag', value:content.tagName});
                                }
                                //form에 추가
                                update.appendTo(editForm);
                                num.appendTo(editForm);
                                tag.appendTo(editForm);
                                editForm.appendTo(parent);
                                //submit 버튼 추가
                                const divBtn = $("<div>").attr('class', 'btn_div');
                                const submitBtn = $("<button>").attr('class','submit').text('확인');
                                submitBtn.appendTo(divBtn);
                                divBtn.appendTo(editForm);
                            })
                        }
                    });
                    $(".contents").mouseout(function(event){
                        if(event.toElement.className!=null && (event.toElement.className=='btn_group' || event.toElement.className=='edit')) {
                        } else {
                            this.setAttribute('class','contents');
                            if($(".btn_group")){
                                $(".btn_group").remove();
                            }
                        }
                    });
                    addEmptyContent();
                } else {
                    // const conNum = data.split("_")[1];
                    const conNum = '8';
                    const contentsDiv = $("<div>").attr({class:'emptyContents show',id:`empty${conNum}-1`});
                    const addCont = $("<img>").attr({class:'addCont',src:'./images/추가.png'}).appendTo(contentsDiv);
                    contentsDiv.appendTo($(".main-content"));

                    addCont.on('mousedown', function(event){
                        addCont.attr('src','./images/추가_클릭.png');
                    })
                    addCont.on('click', function(event){
                        const parent = this.parentElement;
                        uploadContents(parent);
                    })
                }
            });
        }

        function addEmptyContent(){
            const contentDiv = $("div.contents");
            for(var i=0; i<contentDiv.length; i++){
                const emptyId = 'empty' + contentDiv[i].id.substring(7,contentDiv[i].id.length)
                const emptyDiv = $("<div>").attr({class:'emptyContents hide',id: emptyId});
                contentDiv[i].after(emptyDiv[0]);
                emptyDiv.on('mouseover', function(event) {
                    if($(".editContent").length==0) {
                        this.setAttribute('class', 'emptyContents show');
                        if (this.children.length == 0) {
                            const addCont = $("<img>").attr({class: 'addCont', src: './images/추가.png'}).appendTo(this);
                            addCont.on('mousedown', function (event) {
                                addCont.attr('src', './images/추가_클릭.png');
                            })
                            addCont.on('click', function (event) {
                                uploadContents(emptyDiv[0]);
                            });
                        }
                    }
                });
                emptyDiv.on('mouseleave', function(event) {
                    // if(event.toElement.className!=null && (event.toElement.className=='body-area')) {
                    if($(".editContent").length==0){
                        this.setAttribute('class', 'emptyContents hide');
                        const childs = this.children;
                        for(var j=0; j<childs.length; j++){
                            childs[j].remove();
                            j--;
                        }
                    }
                    // }
                });
            }
        }

        function uploadContents(parent){
            const menu = parent.id.split("-")[0];
            parent.children[0].remove();
            const addImg = $("<img>").attr({class:'addImg',src:'./images/이미지.png',style:'width:100px;'}).appendTo(parent);
            const addText = $("<img>").attr({class:'addText',src:'./images/글.png',style:'width:52px;'}).appendTo(parent);
            addImg.on('mousedown', function(event){
                this.setAttribute('src','./images/이미지_클릭.png');
            })
            addText.on('mousedown', function(event){
                this.setAttribute('src','./images/글_클릭.png');
            })
            addImg.on('click', function(event){
                const parent = this.parentElement;
               this.remove();
                $(".addText").remove();
                const num = parent.id.split("-")[1];
                const folder = 'content'+ $("li[class='menu active']")[0].id.split("_")[1];
                const uploadForm = $("<form>").attr({class:'uploadForm',action:'/main/upload',encType:'multipart/form-data',method:'POST'});
                $("<input>").attr({type:'hidden', name:'folder', value:folder}).appendTo(uploadForm);
                $("<input>").attr({type:'hidden', name:'num', value:num}).appendTo(uploadForm);
                $("<input>").attr({type:'file',name:'content_img',accept:'image/jpg,image/png,image/jpeg'}).appendTo(uploadForm);
                var submitBtn = $("<input>").attr({type:'submit'});
                uploadForm.appendTo(parent);
                submitBtn.appendTo(parent);

                submitBtn.on('click', function(event){
                    var formData = new FormData($(".uploadForm")[0]);
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST" , "/main/upload" );
                    xhr.send(formData);

                    xhr.addEventListener('load', function(){
                        const main_content = document.querySelector('.main-content');
                        main_content.innerHTML = xhr.responseText;
                    });
                });
            })
            addText.on('click', function(event){
                const parent = this.parentElement;
                parent.className = 'emptyContents';
                parent.style.height = 'auto';
                const contentName = 'content'+parent.id.substring(5,parent.id.length)
                this.remove();
                $(".addImg").remove();
                const editForm = $("<form>").attr({class:'editForm',action:'/main/update', method:'POST'});
                $("<textarea>").attr({class:'editContent',rows:'3',cols:'100',name:'editData'}).appendTo(editForm);
                $("<input>").attr({type:'hidden', name:'num', value:contentName}).appendTo(editForm);
                $("<input>").attr({type:'hidden', name:'tag', value:'H1'}).appendTo(editForm);
                //form에 추가
                editForm.appendTo(parent);
                //submit 버튼 추가
                const divBtn = $("<div>").attr('class', 'btn_div');
                const submitBtn = $("<button>").attr('class','submit').text('확인');
                submitBtn.appendTo(divBtn);
                divBtn.appendTo(editForm);
            });
        }
    </script>
</body>
</html>

